<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>chatterbox</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">

    <!-- dependencies -->
    <script src="bower_components/jquery/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/underscore/underscore-min.js"></script>
    <script src="bower_components/backbone/backbone-min.js"></script>

    <!-- your scripts -->
    <script src="env/config.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/models.js"></script>
  </head>
  <body>
    <div id="main">
      <div id="friends"></div>
      <h1>chatterbox</h1>
      <form id="form">
        <input type="text" id="text" />
        <input type="submit">
        <button type="button" id="clear">Clear Messages</button>
        <button type="button" id="unfilter">Show All Messages</button>
      </form>

      <div id="chats"></div>

    </div>
    <script>
      $(document).ready(function() {
        /******************
        *  INIT
        *******************/
        app.cutoff = new Date(0);

        app.messages = new Messages();
        app.messages.fetch();
        app.messagesView = new MessagesView({ model: app.messages });

        app.friends = new Friends();
        app.friendsView = new FriendsView({ model: app.friends });

        $('#chats').html(app.messagesView.render());
        $('#form').on('submit', function(e) {
          console.log("submitted")
          e.preventDefault();
          var message = new Message();
          message.set('username', window.username);
          message.set('text', $("#text").val());
          app.send(message.attributes);
          $('#text').val('');
        });

        $('#clear').on('click', function(e) {
          app.cutoff = Date.now();
          e.preventDefault();
          $('#chats').empty();
        })


        $('#chats').on('click', '.username', function() {
          var username = $(this).text();
          app.messages.query = {'username': username};

          if(!app.friends.findWhere({'username': username})) {
            var friend = new Friend(username);
            app.friends.push(friend);
          }
        });

        $('#unfilter').on('click', function() {
          app.messages.query = '';
        });

        setInterval(function() {
          var currentQuery = app.messages.query;
          var currentURL = app.messages.url;
          if( currentQuery !== '') {
            var urlString = 'https://api.parse.com/1/classes/chatterbox?where=' + encodeURIComponent(JSON.stringify(currentQuery));
            app.messages.url = urlString;
          }
          else {
            app.messages.url = 'https://api.parse.com/1/classes/chatterbox';
          }

          app.messages.fetch();
          $('#chats').empty();
          $('#chats').html(app.messagesView.render());

          $('#friends').html(app.friendsView.render());

        }, 500);
      });
    </script>
  </body>
</html>
